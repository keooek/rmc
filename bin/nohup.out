#!/bin/bash -xv

sink="bluez_card.00_1D_43_AA_35_A7"
+ sink=bluez_card.00_1D_43_AA_35_A7
changed_headset="no"; [[ ! -z "$(grep "ALSA:default" /home/pi/.kodi/userdata/guisettings.xml)" ]] && changed_headset="yes"
+ changed_headset=no
++ grep ALSA:default /home/pi/.kodi/userdata/guisettings.xml
+ [[ ! -z '' ]]
changed_hdmi="no"; [[ ! -z "$(grep "PI:Both" /home/pi/.kodi/userdata/guisettings.xml)" ]] && changed_hdmi="yes"
+ changed_hdmi=no
++ grep PI:Both /home/pi/.kodi/userdata/guisettings.xml
+ [[ ! -z         <audiodevice>PI:Both</audiodevice> ]]
+ changed_hdmi=yes

while true; do
 if [[ ! -z $(pidof pulseaudio) && ! -z $(pidof kodi_v7.bin) ]] ; then
 if [[ "$(/usr/bin/pactl list cards short)" == *$sink* ]] ; then
  if [[ $changed_headset == "no" ]] ; then
   card="$(/usr/bin/pactl list cards short| grep $sink | cut -f1)"
   /usr/bin/pacmd set-card-profile $sink a2dp_sink
   /usr/bin/curl -H 'content-type: application/json;' http://$rmc_kodi_ip/jsonrpc --data-binary '{ "jsonrpc": "2.0", "method": "Settings.SetSettingValue", "params":{"setting": "audiooutput.audiodevice", "value": "ALSA:default"}, "id": "mybash"}'
   changed_headset="yes"
   changed_hdmi="no"
  fi
 else
  if [[ $changed_hdmi == "no" ]] ; then
   /usr/bin/curl -H 'content-type: application/json;' http://$rmc_kodi_ip/jsonrpc --data-binary '{ "jsonrpc": "2.0", "method": "Settings.SetSettingValue", "params":{"setting": "audiooutput.audiodevice", "value": "PI:Both"}, "id": "mybash"}'
   changed_headset="no"
   changed_hdmi="yes" 
  fi
 fi
 fi
 sleep 2
done
+ true
++ pidof pulseaudio
+ [[ ! -z 1706 ]]
++ pidof kodi_v7.bin
+ [[ ! -z 1755 ]]
++ /usr/bin/pactl list cards short
+ [[ 0	alsa_card.platform-soc_audio	module-alsa-card.c
2	bluez_card.00_1D_43_AA_35_A7	module-bluez5-device.c == *bluez_card.00_1D_43_AA_35_A7* ]]
+ [[ no == \n\o ]]
++ grep bluez_card.00_1D_43_AA_35_A7
++ /usr/bin/pactl list cards short
++ cut -f1
+ card=2
+ /usr/bin/pacmd set-card-profile bluez_card.00_1D_43_AA_35_A7 a2dp_sink
+ /usr/bin/curl -H 'content-type: application/json;' http://192.168.1.7:8080/jsonrpc --data-binary '{ "jsonrpc": "2.0", "method": "Settings.SetSettingValue", "params":{"setting": "audiooutput.audiodevice", "value": "ALSA:default"}, "id": "mybash"}'
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0100   192  100    45  100   147   5600  18294 --:--:-- --:--:-- --:--:-- 24500
{"id":"mybash","jsonrpc":"2.0","result":true}+ changed_headset=yes
+ changed_hdmi=no
+ sleep 2
+ true
++ pidof pulseaudio
+ [[ ! -z 1706 ]]
++ pidof kodi_v7.bin
+ [[ ! -z 1755 ]]
++ /usr/bin/pactl list cards short
+ [[ 0	alsa_card.platform-soc_audio	module-alsa-card.c
2	bluez_card.00_1D_43_AA_35_A7	module-bluez5-device.c == *bluez_card.00_1D_43_AA_35_A7* ]]
+ [[ yes == \n\o ]]
+ sleep 2
+ true
++ pidof pulseaudio
+ [[ ! -z 1706 ]]
++ pidof kodi_v7.bin
+ [[ ! -z 1755 ]]
++ /usr/bin/pactl list cards short
+ [[ 0	alsa_card.platform-soc_audio	module-alsa-card.c
2	bluez_card.00_1D_43_AA_35_A7	module-bluez5-device.c == *bluez_card.00_1D_43_AA_35_A7* ]]
+ [[ yes == \n\o ]]
+ sleep 2
+ true
++ pidof pulseaudio
+ [[ ! -z 1706 ]]
++ pidof kodi_v7.bin
+ [[ ! -z 1755 ]]
++ /usr/bin/pactl list cards short
+ [[ 0	alsa_card.platform-soc_audio	module-alsa-card.c
2	bluez_card.00_1D_43_AA_35_A7	module-bluez5-device.c == *bluez_card.00_1D_43_AA_35_A7* ]]
+ [[ yes == \n\o ]]
+ sleep 2
+ true
++ pidof pulseaudio
+ [[ ! -z 1706 ]]
++ pidof kodi_v7.bin
+ [[ ! -z 1755 ]]
++ /usr/bin/pactl list cards short
+ [[ 0	alsa_card.platform-soc_audio	module-alsa-card.c
2	bluez_card.00_1D_43_AA_35_A7	module-bluez5-device.c == *bluez_card.00_1D_43_AA_35_A7* ]]
+ [[ yes == \n\o ]]
+ sleep 2
+ true
++ pidof pulseaudio
+ [[ ! -z 1706 ]]
++ pidof kodi_v7.bin
+ [[ ! -z 1755 ]]
++ /usr/bin/pactl list cards short
+ [[ 0	alsa_card.platform-soc_audio	module-alsa-card.c
2	bluez_card.00_1D_43_AA_35_A7	module-bluez5-device.c == *bluez_card.00_1D_43_AA_35_A7* ]]
+ [[ yes == \n\o ]]
+ sleep 2
+ true
++ pidof pulseaudio
+ [[ ! -z 1706 ]]
++ pidof kodi_v7.bin
+ [[ ! -z 1755 ]]
++ /usr/bin/pactl list cards short
+ [[ 0	alsa_card.platform-soc_audio	module-alsa-card.c
2	bluez_card.00_1D_43_AA_35_A7	module-bluez5-device.c == *bluez_card.00_1D_43_AA_35_A7* ]]
+ [[ yes == \n\o ]]
+ sleep 2
+ true
++ pidof pulseaudio
+ [[ ! -z 1706 ]]
++ pidof kodi_v7.bin
+ [[ ! -z 1755 ]]
++ /usr/bin/pactl list cards short
+ [[ 0	alsa_card.platform-soc_audio	module-alsa-card.c
2	bluez_card.00_1D_43_AA_35_A7	module-bluez5-device.c == *bluez_card.00_1D_43_AA_35_A7* ]]
+ [[ yes == \n\o ]]
+ sleep 2
+ true
++ pidof pulseaudio
+ [[ ! -z 1706 ]]
++ pidof kodi_v7.bin
+ [[ ! -z 1755 ]]
++ /usr/bin/pactl list cards short
+ [[ 0	alsa_card.platform-soc_audio	module-alsa-card.c
2	bluez_card.00_1D_43_AA_35_A7	module-bluez5-device.c == *bluez_card.00_1D_43_AA_35_A7* ]]
+ [[ yes == \n\o ]]
+ sleep 2
+ true
++ pidof pulseaudio
+ [[ ! -z 1706 ]]
++ pidof kodi_v7.bin
+ [[ ! -z 1755 ]]
++ /usr/bin/pactl list cards short
+ [[ 0	alsa_card.platform-soc_audio	module-alsa-card.c
2	bluez_card.00_1D_43_AA_35_A7	module-bluez5-device.c == *bluez_card.00_1D_43_AA_35_A7* ]]
+ [[ yes == \n\o ]]
+ sleep 2
+ true
++ pidof pulseaudio
+ [[ ! -z 1706 ]]
++ pidof kodi_v7.bin
+ [[ ! -z 1755 ]]
++ /usr/bin/pactl list cards short
+ [[ 0	alsa_card.platform-soc_audio	module-alsa-card.c
2	bluez_card.00_1D_43_AA_35_A7	module-bluez5-device.c == *bluez_card.00_1D_43_AA_35_A7* ]]
+ [[ yes == \n\o ]]
+ sleep 2
+ true
++ pidof pulseaudio
+ [[ ! -z 1706 ]]
++ pidof kodi_v7.bin
+ [[ ! -z 1755 ]]
++ /usr/bin/pactl list cards short
+ [[ 0	alsa_card.platform-soc_audio	module-alsa-card.c
2	bluez_card.00_1D_43_AA_35_A7	module-bluez5-device.c == *bluez_card.00_1D_43_AA_35_A7* ]]
+ [[ yes == \n\o ]]
+ sleep 2
+ true
++ pidof pulseaudio
+ [[ ! -z 1706 ]]
++ pidof kodi_v7.bin
+ [[ ! -z 1755 ]]
++ /usr/bin/pactl list cards short
+ [[ 0	alsa_card.platform-soc_audio	module-alsa-card.c
2	bluez_card.00_1D_43_AA_35_A7	module-bluez5-device.c == *bluez_card.00_1D_43_AA_35_A7* ]]
+ [[ yes == \n\o ]]
+ sleep 2
+ true
++ pidof pulseaudio
+ [[ ! -z 1706 ]]
++ pidof kodi_v7.bin
+ [[ ! -z 1755 ]]
++ /usr/bin/pactl list cards short
+ [[ 0	alsa_card.platform-soc_audio	module-alsa-card.c
2	bluez_card.00_1D_43_AA_35_A7	module-bluez5-device.c == *bluez_card.00_1D_43_AA_35_A7* ]]
+ [[ yes == \n\o ]]
+ sleep 2
+ true
++ pidof pulseaudio
+ [[ ! -z 1706 ]]
++ pidof kodi_v7.bin
+ [[ ! -z 1755 ]]
++ /usr/bin/pactl list cards short
+ [[ 0	alsa_card.platform-soc_audio	module-alsa-card.c
2	bluez_card.00_1D_43_AA_35_A7	module-bluez5-device.c == *bluez_card.00_1D_43_AA_35_A7* ]]
+ [[ yes == \n\o ]]
+ sleep 2
+ true
++ pidof pulseaudio
+ [[ ! -z 1706 ]]
++ pidof kodi_v7.bin
+ [[ ! -z 1755 ]]
++ /usr/bin/pactl list cards short
+ [[ 0	alsa_card.platform-soc_audio	module-alsa-card.c
2	bluez_card.00_1D_43_AA_35_A7	module-bluez5-device.c == *bluez_card.00_1D_43_AA_35_A7* ]]
+ [[ yes == \n\o ]]
+ sleep 2
+ true
++ pidof pulseaudio
+ [[ ! -z 1706 ]]
++ pidof kodi_v7.bin
+ [[ ! -z 1755 ]]
++ /usr/bin/pactl list cards short
+ [[ 0	alsa_card.platform-soc_audio	module-alsa-card.c
2	bluez_card.00_1D_43_AA_35_A7	module-bluez5-device.c == *bluez_card.00_1D_43_AA_35_A7* ]]
+ [[ yes == \n\o ]]
+ sleep 2
+ true
++ pidof pulseaudio
+ [[ ! -z 1706 ]]
++ pidof kodi_v7.bin
+ [[ ! -z 1755 ]]
++ /usr/bin/pactl list cards short
+ [[ 0	alsa_card.platform-soc_audio	module-alsa-card.c
2	bluez_card.00_1D_43_AA_35_A7	module-bluez5-device.c == *bluez_card.00_1D_43_AA_35_A7* ]]
+ [[ yes == \n\o ]]
+ sleep 2
+ true
++ pidof pulseaudio
+ [[ ! -z 1706 ]]
++ pidof kodi_v7.bin
+ [[ ! -z 1755 ]]
++ /usr/bin/pactl list cards short
+ [[ 0	alsa_card.platform-soc_audio	module-alsa-card.c
2	bluez_card.00_1D_43_AA_35_A7	module-bluez5-device.c == *bluez_card.00_1D_43_AA_35_A7* ]]
+ [[ yes == \n\o ]]
+ sleep 2
+ true
++ pidof pulseaudio
+ [[ ! -z 1706 ]]
++ pidof kodi_v7.bin
+ [[ ! -z 1755 ]]
++ /usr/bin/pactl list cards short
+ [[ 0	alsa_card.platform-soc_audio	module-alsa-card.c
2	bluez_card.00_1D_43_AA_35_A7	module-bluez5-device.c == *bluez_card.00_1D_43_AA_35_A7* ]]
+ [[ yes == \n\o ]]
+ sleep 2
+ true
++ pidof pulseaudio
+ [[ ! -z 1706 ]]
++ pidof kodi_v7.bin
+ [[ ! -z 1755 ]]
++ /usr/bin/pactl list cards short
+ [[ 0	alsa_card.platform-soc_audio	module-alsa-card.c
2	bluez_card.00_1D_43_AA_35_A7	module-bluez5-device.c == *bluez_card.00_1D_43_AA_35_A7* ]]
+ [[ yes == \n\o ]]
+ sleep 2
+ true
++ pidof pulseaudio
+ [[ ! -z 1706 ]]
++ pidof kodi_v7.bin
+ [[ ! -z 1755 ]]
++ /usr/bin/pactl list cards short
+ [[ 0	alsa_card.platform-soc_audio	module-alsa-card.c
2	bluez_card.00_1D_43_AA_35_A7	module-bluez5-device.c == *bluez_card.00_1D_43_AA_35_A7* ]]
+ [[ yes == \n\o ]]
+ sleep 2
+ true
++ pidof pulseaudio
+ [[ ! -z 1706 ]]
++ pidof kodi_v7.bin
+ [[ ! -z 1755 ]]
++ /usr/bin/pactl list cards short
+ [[ 0	alsa_card.platform-soc_audio	module-alsa-card.c
2	bluez_card.00_1D_43_AA_35_A7	module-bluez5-device.c == *bluez_card.00_1D_43_AA_35_A7* ]]
+ [[ yes == \n\o ]]
+ sleep 2
+ true
++ pidof pulseaudio
+ [[ ! -z 1706 ]]
++ pidof kodi_v7.bin
+ [[ ! -z 1755 ]]
++ /usr/bin/pactl list cards short
+ [[ 0	alsa_card.platform-soc_audio	module-alsa-card.c
2	bluez_card.00_1D_43_AA_35_A7	module-bluez5-device.c == *bluez_card.00_1D_43_AA_35_A7* ]]
+ [[ yes == \n\o ]]
+ sleep 2
+ true
++ pidof pulseaudio
+ [[ ! -z 1706 ]]
++ pidof kodi_v7.bin
+ [[ ! -z 1755 ]]
++ /usr/bin/pactl list cards short
+ [[ 0	alsa_card.platform-soc_audio	module-alsa-card.c
2	bluez_card.00_1D_43_AA_35_A7	module-bluez5-device.c == *bluez_card.00_1D_43_AA_35_A7* ]]
+ [[ yes == \n\o ]]
+ sleep 2
+ true
++ pidof pulseaudio
+ [[ ! -z 1706 ]]
++ pidof kodi_v7.bin
+ [[ ! -z 1755 ]]
++ /usr/bin/pactl list cards short
+ [[ 0	alsa_card.platform-soc_audio	module-alsa-card.c
2	bluez_card.00_1D_43_AA_35_A7	module-bluez5-device.c == *bluez_card.00_1D_43_AA_35_A7* ]]
+ [[ yes == \n\o ]]
+ sleep 2
+ true
++ pidof pulseaudio
+ [[ ! -z 1706 ]]
++ pidof kodi_v7.bin
+ [[ ! -z 1755 ]]
++ /usr/bin/pactl list cards short
+ [[ 0	alsa_card.platform-soc_audio	module-alsa-card.c
2	bluez_card.00_1D_43_AA_35_A7	module-bluez5-device.c == *bluez_card.00_1D_43_AA_35_A7* ]]
+ [[ yes == \n\o ]]
+ sleep 2
+ true
++ pidof pulseaudio
+ [[ ! -z 1706 ]]
++ pidof kodi_v7.bin
+ [[ ! -z 1755 ]]
++ /usr/bin/pactl list cards short
+ [[ 0	alsa_card.platform-soc_audio	module-alsa-card.c
2	bluez_card.00_1D_43_AA_35_A7	module-bluez5-device.c == *bluez_card.00_1D_43_AA_35_A7* ]]
+ [[ yes == \n\o ]]
+ sleep 2
+ true
++ pidof pulseaudio
+ [[ ! -z 1706 ]]
++ pidof kodi_v7.bin
+ [[ ! -z 1755 ]]
++ /usr/bin/pactl list cards short
+ [[ 0	alsa_card.platform-soc_audio	module-alsa-card.c
2	bluez_card.00_1D_43_AA_35_A7	module-bluez5-device.c == *bluez_card.00_1D_43_AA_35_A7* ]]
+ [[ yes == \n\o ]]
+ sleep 2
+ true
++ pidof pulseaudio
+ [[ ! -z 1706 ]]
++ pidof kodi_v7.bin
+ [[ ! -z 1755 ]]
++ /usr/bin/pactl list cards short
+ [[ 0	alsa_card.platform-soc_audio	module-alsa-card.c
2	bluez_card.00_1D_43_AA_35_A7	module-bluez5-device.c == *bluez_card.00_1D_43_AA_35_A7* ]]
+ [[ yes == \n\o ]]
+ sleep 2
+ true
++ pidof pulseaudio
+ [[ ! -z 1706 ]]
++ pidof kodi_v7.bin
+ [[ ! -z 1755 ]]
++ /usr/bin/pactl list cards short
+ [[ 0	alsa_card.platform-soc_audio	module-alsa-card.c
2	bluez_card.00_1D_43_AA_35_A7	module-bluez5-device.c == *bluez_card.00_1D_43_AA_35_A7* ]]
+ [[ yes == \n\o ]]
+ sleep 2
+ true
++ pidof pulseaudio
+ [[ ! -z 1706 ]]
++ pidof kodi_v7.bin
+ [[ ! -z 1755 ]]
++ /usr/bin/pactl list cards short
+ [[ 0	alsa_card.platform-soc_audio	module-alsa-card.c
2	bluez_card.00_1D_43_AA_35_A7	module-bluez5-device.c == *bluez_card.00_1D_43_AA_35_A7* ]]
+ [[ yes == \n\o ]]
+ sleep 2
